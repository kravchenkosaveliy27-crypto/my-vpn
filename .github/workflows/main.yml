name: Sync External File

on:
  schedule:
    - cron: "*/1 * * * *"  # –ö–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  sync-file:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and process file
        id: process
        run: |
          SOURCE_URL="https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/Vless-Reality-White-Lists-Rus-Mobile.txt"
          TARGET_FILE="my_config.txt"
          
          echo "TARGET_FILE=$TARGET_FILE" >> $GITHUB_ENV
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          
          echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑: $SOURCE_URL"
          
          if curl -L --fail --max-time 30 -o temp_download.txt "$SOURCE_URL"; then
            echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω"
            
            if [ ! -s temp_download.txt ]; then
              echo "‚ùå –§–∞–π–ª –ø—É—Å—Ç–æ–π"
              exit 1
            fi
            
            ORIGINAL_LINES=$(wc -l < temp_download.txt)
            echo "üìä –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $ORIGINAL_LINES —Å—Ç—Ä–æ–∫"
            
            # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
            tail -n +3 temp_download.txt > "$TARGET_FILE"
            
            PROCESSED_LINES=$(wc -l < "$TARGET_FILE")
            echo "üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $PROCESSED_LINES —Å—Ç—Ä–æ–∫"
            
            if [ "$PROCESSED_LINES" -eq 0 ]; then
              echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—É—Å—Ç!"
            fi
            
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
            head -5 "$TARGET_FILE"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞"
            exit 1
          fi

      - name: Force commit and push (every 2 minutes)
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∫–æ–º–º–∏—Ç (–≤—Å–µ–≥–¥–∞)
          git add "${{ env.TARGET_FILE }}"
          
          # –î–æ–±–∞–≤–ª—è–µ–º timestamp —Ñ–∞–π–ª
          cat > last_update.txt << EOF
          Last update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Source: ${{ env.SOURCE_URL }}
          EOF
          git add last_update.txt
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –¥–æ–±–∞–≤–∏–º –ø—É—Å—Ç–æ–π –∫–æ–º–º–∏—Ç —Å –¥–∞—Ç–æ–π)
          git commit -m "üîÑ Auto-update: $(date +'%Y-%m-%d %H:%M:%S UTC')" || echo "No changes to commit"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          
          echo "‚úÖ –§–∞–π–ª –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏"
