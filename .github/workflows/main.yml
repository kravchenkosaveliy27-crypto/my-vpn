name: Sync External File

on:
  schedule:
    - cron: "*/10 * * * *"  # –ö–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç
  workflow_dispatch:
  push:
    branches: [ main ]  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –ø—É—à–µ

jobs:
  sync-file:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and process file
        id: process
        run: |
          SOURCE_URL="https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/Vless-Reality-White-Lists-Rus-Mobile.txt"
          TARGET_FILE="my_config.txt"
          
          echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑: $SOURCE_URL"
          
          # –°–∫–∞—á–∏–≤–∞–µ–º —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
          if curl -L --fail --max-time 30 -o temp_download.txt "$SOURCE_URL"; then
            echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ–π —Ñ–∞–π–ª
            if [ ! -s temp_download.txt ]; then
              echo "‚ùå –§–∞–π–ª –ø—É—Å—Ç–æ–π"
              exit 1
            fi
            
            # –ü–æ–¥—Å—á–µ—Ç —Å—Ç—Ä–æ–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ
            ORIGINAL_LINES=$(wc -l < temp_download.txt)
            echo "üìä –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $ORIGINAL_LINES —Å—Ç—Ä–æ–∫"
            
            # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
            tail -n +3 temp_download.txt > "$TARGET_FILE"
            
            # –ü–æ–¥—Å—á–µ—Ç —Å—Ç—Ä–æ–∫ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            PROCESSED_LINES=$(wc -l < "$TARGET_FILE")
            echo "üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $PROCESSED_LINES —Å—Ç—Ä–æ–∫"
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            if [ "$PROCESSED_LINES" -eq 0 ]; then
              echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—É—Å—Ç!"
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
            head -5 "$TARGET_FILE"
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            echo "source_url=$SOURCE_URL" >> $GITHUB_OUTPUT
            echo "processed_lines=$PROCESSED_LINES" >> $GITHUB_OUTPUT
            echo "original_lines=$ORIGINAL_LINES" >> $GITHUB_OUTPUT
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ñ–∞–π–ª
          if git diff --quiet "$TARGET_FILE"; then
            echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–∞–π–ª–µ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º diff
            echo "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è:"
            git diff "$TARGET_FILE" | head -20
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∫–æ–º–º–∏—Ç
          git add "$TARGET_FILE"
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          git commit -m "üîÑ Auto-update from external source

          Source: ${{ steps.process.outputs.source_url }}
          Original lines: ${{ steps.process.outputs.original_lines }}
          Processed lines: ${{ steps.process.outputs.processed_lines }}
          Update time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"

      - name: Create timestamp file (optional)
        run: |
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
          cat > last_update.txt << EOF
          Last update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Source: ${{ steps.process.outputs.source_url }}
          Original lines: ${{ steps.process.outputs.original_lines }}
          Processed lines: ${{ steps.process.outputs.processed_lines }}
          EOF
          
          # –ö–æ–º–º–∏—Ç–∏–º timestamp —Ñ–∞–π–ª –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          git add last_update.txt || true

      - name: Send notification (optional)
        if: failure()
        run: |
          echo "‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
          # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ Telegram
          # curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" ...
