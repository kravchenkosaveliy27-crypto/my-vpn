name: Sync External File

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  sync-file:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and process file
        id: process
        run: |
          SOURCE_URL="https://raw.githubusercontent.com/igareck/vpn-configs-for-russia/refs/heads/main/Vless-Reality-White-Lists-Rus-Mobile.txt"
          TARGET_FILE="my_config.txt"
          
          echo "TARGET_FILE=$TARGET_FILE" >> $GITHUB_ENV
          echo "SOURCE_URL=$SOURCE_URL" >> $GITHUB_ENV
          
          echo "üì• –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª –∏–∑: $SOURCE_URL"
          
          if curl -L --fail --max-time 30 -o temp_download.txt "$SOURCE_URL"; then
            echo "‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–∫–∞—á–∞–Ω"
            
            if [ ! -s temp_download.txt ]; then
              echo "‚ùå –§–∞–π–ª –ø—É—Å—Ç–æ–π"
              exit 1
            fi
            
            ORIGINAL_LINES=$(wc -l < temp_download.txt)
            echo "üìä –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $ORIGINAL_LINES —Å—Ç—Ä–æ–∫"
            
            # –£–¥–∞–ª—è–µ–º –ø–µ—Ä–≤—ã–µ –¥–≤–µ —Å—Ç—Ä–æ–∫–∏
            tail -n +3 temp_download.txt > "$TARGET_FILE"
            
            PROCESSED_LINES=$(wc -l < "$TARGET_FILE")
            echo "üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç $PROCESSED_LINES —Å—Ç—Ä–æ–∫"
            
            if [ "$PROCESSED_LINES" -eq 0 ]; then
              echo "‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –ø—É—Å—Ç!"
            fi
            
            echo "üìÑ –ü–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:"
            head -5 "$TARGET_FILE"
          else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞"
            exit 1
          fi

      - name: Check for changes
        id: check_changes
        run: |
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ñ–∞–π–ª
          if git diff --quiet "${{ env.TARGET_FILE }}"; then
            echo "üì≠ –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Ñ–∞–π–ª–µ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è:"
            git diff "${{ env.TARGET_FILE }}" | head -20 || true
          fi

      - name: Commit and push
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions-bot@users.noreply.github.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ –∫–æ–º–º–∏—Ç
          git add "${{ env.TARGET_FILE }}"
          
          # –°–æ–∑–¥–∞–µ–º –∫–æ–º–º–∏—Ç
          git commit -m "üîÑ Auto-update from external source [$(date +'%Y-%m-%d %H:%M')]"
          
          # –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git push
          
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"

      - name: Create timestamp file
        run: |
          # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
          cat > last_update.txt << EOF
          Last update: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          Source: ${{ env.SOURCE_URL }}
          EOF
          
          # –î–æ–±–∞–≤–ª—è–µ–º timestamp —Ñ–∞–π–ª –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add last_update.txt 2>/dev/null || true
